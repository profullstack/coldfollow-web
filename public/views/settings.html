<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - convert2doc</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <div class="container">
    <div class="settings-container">
      <h1 class="page-title">Account Settings</h1>
      
      <div class="card">
        <h2 class="card-title">Profile Information</h2>
        <form id="profile-form">
          <div class="form-group">
            <label for="display-name">Display Name</label>
            <input type="text" id="display-name" name="display-name" class="form-control">
          </div>
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" class="form-control" readonly>
          </div>
          
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
      
      <div class="card">
        <h2 class="card-title">Change Password</h2>
        <form id="password-form">
          <div class="form-group">
            <label for="current-password">Current Password</label>
            <input type="password" id="current-password" name="current-password" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="new-password">New Password</label>
            <input type="password" id="new-password" name="new-password" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="confirm-password">Confirm New Password</label>
            <input type="password" id="confirm-password" name="confirm-password" class="form-control" required>
          </div>
          
          <button type="submit" class="btn btn-primary">Change Password</button>
        </form>
      </div>
      
      <div class="card">
        <h2 class="card-title">Subscription</h2>
        <div class="subscription-info">
          <p><strong>Current Plan:</strong> <span id="current-plan">Monthly ($5/month)</span></p>
          <p><strong>Next Billing Date:</strong> <span id="next-billing">May 18, 2025</span></p>
          <p><strong>Payment Method:</strong> <span id="payment-method">Bitcoin</span></p>
        </div>
        
        <a href="/subscription" class="btn btn-primary">Manage Subscription</a>
        
        <div class="danger-zone">
          <h3 class="danger-title">Danger Zone</h3>
          <p>Cancel your subscription and delete your account. This action cannot be undone.</p>
          <button id="delete-account" class="btn btn-danger">Delete Account</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Check if user is logged in
    const apiKey = localStorage.getItem('api_key');
    const userJson = localStorage.getItem('user');
    let user = null;
    
    if (userJson) {
      try {
        user = JSON.parse(userJson);
      } catch (e) {
        console.error('Error parsing user JSON:', e);
      }
    }
    
    if (!apiKey) {
      // Redirect to login page if not logged in
      window.location.href = '/login';
      throw new Error('Not logged in');
    }
    
    // Populate form fields
    document.getElementById('email').value = user?.email || apiKey;
    document.getElementById('display-name').value = user?.username || localStorage.getItem('username') || apiKey;
    
    // Populate subscription info if available
    if (user?.subscription) {
      document.getElementById('current-plan').textContent =
        user.subscription.plan === 'yearly' ? 'Yearly ($30/year)' : 'Monthly ($5/month)';
      
      if (user.subscription.expiresAt) {
        const expiryDate = new Date(user.subscription.expiresAt);
        document.getElementById('next-billing').textContent = expiryDate.toLocaleDateString();
      }
    }
    
    // Handle profile form submission
    document.getElementById('profile-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const displayName = document.getElementById('display-name').value;
      
      // Update username in localStorage
      localStorage.setItem('username', displayName);
      
      // Update user object
      if (user) {
        user.username = displayName;
        localStorage.setItem('user', JSON.stringify(user));
      }
      
      // Dispatch auth changed event to update the header
      window.dispatchEvent(new CustomEvent('auth-changed'));
      
      // Show success message
      alert('Profile updated successfully!');
    });
    
    // Handle password form submission
    document.getElementById('password-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
      }
      
      // In a real implementation, this would validate the current password
      // and update the password on the server
      
      alert('Password changed successfully!');
      
      // Clear form
      e.target.reset();
    });
    
    // Handle delete account button
    document.getElementById('delete-account').addEventListener('click', () => {
      const confirmed = confirm('Are you sure you want to delete your account? This action cannot be undone.');
      
      if (confirmed) {
        // In a real implementation, this would delete the account on the server
        
        // Clear all localStorage
        localStorage.clear();
        
        // Clear all cookies
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i];
          const eqPos = cookie.indexOf("=");
          const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
          document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        
        // Dispatch auth changed event
        window.dispatchEvent(new CustomEvent('auth-changed'));
        
        // Redirect to home page
        window.location.href = '/';
      }
    });
  </script>
</body>
</html>