<div class="auth-container">
  <h1>Reset Password</h1>
  <p class="auth-description">Enter your new password below.</p>
  
  <form id="reset-password-form" class="auth-form">
    <div class="form-group">
      <label for="password">New Password</label>
      <input type="password" id="password" name="password" required minlength="8" placeholder="Enter your new password">
      <small>Password must be at least 8 characters</small>
    </div>
    
    <div class="form-group">
      <label for="confirm-password">Confirm Password</label>
      <input type="password" id="confirm-password" name="confirm-password" required minlength="8" placeholder="Confirm your new password">
    </div>
    
    <button type="submit" class="btn btn-primary">Reset Password</button>
  </form>
  
  <div class="auth-links">
    <a href="/login">Back to Login</a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('reset-password-form');
    if (!form) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      // Show loading state
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.textContent;
      submitButton.textContent = 'Resetting...';
      submitButton.disabled = true;
      
      try {
        // Import Supabase client for JWT authentication
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        const supabaseUrl = 'https://arokhsfbkdnfuklmqajh.supabase.co'; // Should match server config
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyb2toc2Zia2RuZnVrbG1xYWpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODI0NTI4MDAsImV4cCI6MTk5ODAyODgwMH0.KxwHdxWXLLrJtFzLAYI-fwzgz8m5xsHD4XGdNw_xJm8'; // Public anon key
        
        console.log('Creating Supabase client for password reset');
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        // Get the JWT token from localStorage
        const jwtToken = localStorage.getItem('jwt_token');
        
        if (!jwtToken) {
          throw new Error('You must be logged in to reset your password');
        }
        
        // Update the user's password
        const { error } = await supabase.auth.updateUser({
          password: password
        });
        
        if (error) {
          throw error;
        }
        
        // Show success message
        alert('Password reset successfully! Please log in with your new password.');
        
        // Redirect to login page
        window.router.navigate('/login');
      } catch (error) {
        console.error('Password reset error:', error);
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
        
        // Show error message
        alert('Password reset failed: ' + (error.message || 'An unknown error occurred'));
      }
    });
  });
</script>